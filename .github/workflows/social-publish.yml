name: Publish to Social Media

on:
  push:
    branches: [main]
    paths:
      - 'src/content/journal/**'

permissions:
  contents: read
  id-token: write  # Required for Workload Identity Federation

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Get changed journal entries
        id: changed
        run: |
          # Get list of changed journal entries
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'src/content/journal/*.md' 2>/dev/null | head -1)
          
          if [ -z "$CHANGED" ]; then
            echo "No journal entries changed"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Changed file: $CHANGED"
            echo "file=$CHANGED" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check publish_social flag and extract content
        if: steps.changed.outputs.skip != 'true'
        id: check
        run: |
          FILE="${{ steps.changed.outputs.file }}"
          
          echo "Checking file: $FILE"
          
          # Read the file content
          CONTENT=$(cat "$FILE")
          
          # Extract frontmatter (between first two ---)
          FRONTMATTER=$(echo "$CONTENT" | sed -n '/^---$/,/^---$/p' | sed '1d;$d')
          
          echo "Frontmatter extracted, checking for publish_social flag..."
          
          # Check for publish_social: true
          if echo "$FRONTMATTER" | grep -q "^publish_social: true"; then
            echo "publish_social flag is TRUE"
            
            # Extract linkedin content (multiline YAML block)
            # This handles the | syntax for multiline strings
            LINKEDIN=$(echo "$FRONTMATTER" | awk '
              /^linkedin:/ { 
                flag=1
                if ($0 ~ /\|/) { next }  # Skip the "linkedin: |" line
                gsub(/^linkedin: */, "")  # Or get inline value
                if (length > 0) print
                next
              }
              /^[a-zA-Z_]+:/ && flag { flag=0 }
              /^---$/ && flag { flag=0 }
              flag { gsub(/^  /, ""); print }
            ')
            
            # Extract threads content
            THREADS=$(echo "$FRONTMATTER" | awk '
              /^threads:/ { 
                flag=1
                if ($0 ~ /\|/) { next }
                gsub(/^threads: */, "")
                if (length > 0) print
                next
              }
              /^[a-zA-Z_]+:/ && flag { flag=0 }
              /^---$/ && flag { flag=0 }
              flag { gsub(/^  /, ""); print }
            ')
            
            # Check if linkedin/threads content actually changed (idempotency check)
            # Get previous version of the file
            git show HEAD~1:"$FILE" > /tmp/prev_file.md 2>/dev/null || echo "" > /tmp/prev_file.md
            
            PREV_FRONTMATTER=$(cat /tmp/prev_file.md | sed -n '/^---$/,/^---$/p' | sed '1d;$d')
            
            PREV_LINKEDIN=$(echo "$PREV_FRONTMATTER" | awk '
              /^linkedin:/ { flag=1; if ($0 ~ /\|/) { next }; gsub(/^linkedin: */, ""); if (length > 0) print; next }
              /^[a-zA-Z_]+:/ && flag { flag=0 }
              /^---$/ && flag { flag=0 }
              flag { gsub(/^  /, ""); print }
            ')
            
            PREV_THREADS=$(echo "$PREV_FRONTMATTER" | awk '
              /^threads:/ { flag=1; if ($0 ~ /\|/) { next }; gsub(/^threads: */, ""); if (length > 0) print; next }
              /^[a-zA-Z_]+:/ && flag { flag=0 }
              /^---$/ && flag { flag=0 }
              flag { gsub(/^  /, ""); print }
            ')
            
            # Extract LinkedIn image URN for hash comparison
            CURR_IMAGE_URN=$(echo "$FRONTMATTER" | grep "^linkedin_image_urn:" | sed 's/linkedin_image_urn: *"//' | sed 's/"$//' | tr -d '"')
            PREV_IMAGE_URN=$(echo "$PREV_FRONTMATTER" | grep "^linkedin_image_urn:" | sed 's/linkedin_image_urn: *"//' | sed 's/"$//' | tr -d '"')
            
            # Extract LinkedIn video URN
            CURR_VIDEO_URN=$(echo "$FRONTMATTER" | grep "^linkedin_video_urn:" | sed 's/linkedin_video_urn: *"//' | sed 's/"$//' | tr -d '"')
            PREV_VIDEO_URN=$(echo "$PREV_FRONTMATTER" | grep "^linkedin_video_urn:" | sed 's/linkedin_video_urn: *"//' | sed 's/"$//' | tr -d '"')
            
            # Compare content hashes (include image/video URN so media changes trigger republish)
            CURR_HASH=$(echo "$LINKEDIN$THREADS$CURR_IMAGE_URN$CURR_VIDEO_URN" | md5sum | cut -d' ' -f1)
            PREV_HASH=$(echo "$PREV_LINKEDIN$PREV_THREADS$PREV_IMAGE_URN$PREV_VIDEO_URN" | md5sum | cut -d' ' -f1)
            
            echo "Current hash: $CURR_HASH"
            echo "Previous hash: $PREV_HASH"
            
            if [ "$CURR_HASH" = "$PREV_HASH" ] && [ -n "$PREV_HASH" ]; then
              echo "Social content unchanged - skipping to prevent duplicate posts"
              echo "should_publish=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "Social content changed or new - will publish to social media"
            echo "should_publish=true" >> $GITHUB_OUTPUT
            
            # Extract audio URL (already full URL like https://audio.relearn.ing/entry-XXX.mp3)
            AUDIO_URL=$(echo "$FRONTMATTER" | grep "^audioUrl:" | sed 's/audioUrl: *"//' | sed 's/"$//')
            
            # Use the image/video URN we already extracted for hash comparison
            IMAGE_URN="$CURR_IMAGE_URN"
            VIDEO_URN="$CURR_VIDEO_URN"
            
            # Debug output
            echo "LinkedIn content length: ${#LINKEDIN}"
            echo "Threads content length: ${#THREADS}"
            echo "Audio URL: $AUDIO_URL"
            echo "Image URN: $IMAGE_URN"
            echo "Video URN: $VIDEO_URN"
            
            # Save to files for proper multiline handling
            echo "$LINKEDIN" > /tmp/linkedin.txt
            echo "$THREADS" > /tmp/threads.txt
            
            # For GitHub outputs, we need to handle multiline differently
            {
              echo 'linkedin<<EOF'
              cat /tmp/linkedin.txt
              echo 'EOF'
            } >> $GITHUB_OUTPUT
            
            {
              echo 'threads<<EOF'
              cat /tmp/threads.txt
              echo 'EOF'
            } >> $GITHUB_OUTPUT
            
            echo "audio_url=$AUDIO_URL" >> $GITHUB_OUTPUT
            echo "image_urn=$IMAGE_URN" >> $GITHUB_OUTPUT
            echo "video_urn=$VIDEO_URN" >> $GITHUB_OUTPUT
            
          else
            echo "publish_social flag is not true, skipping social media publish"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        if: steps.check.outputs.should_publish == 'true'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        if: steps.check.outputs.should_publish == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: Publish to Pub/Sub
        if: steps.check.outputs.should_publish == 'true'
        env:
          LINKEDIN_CONTENT: ${{ steps.check.outputs.linkedin }}
          THREADS_CONTENT: ${{ steps.check.outputs.threads }}
          AUDIO_URL: ${{ steps.check.outputs.audio_url }}
          IMAGE_URN: ${{ steps.check.outputs.image_urn }}
          VIDEO_URN: ${{ steps.check.outputs.video_urn }}
        run: |
          echo "Publishing to social media via Pub/Sub..."
          
          # Build the JSON payload using jq for proper escaping
          PAYLOAD=$(jq -n \
            --arg linkedin "$LINKEDIN_CONTENT" \
            --arg threads "$THREADS_CONTENT" \
            --arg audio_url "$AUDIO_URL" \
            --arg image_urn "$IMAGE_URN" \
            --arg video_urn "$VIDEO_URN" \
            '{
              content: "New journal entry published",
              linkedin_content: $linkedin,
              threads_content: $threads,
              audio_url: $audio_url,
              image_urn: $image_urn,
              video_urn: $video_urn
            }')
          
          echo "Payload:"
          echo "$PAYLOAD" | jq .
          
          # Publish to Pub/Sub
          gcloud pubsub topics publish social-publish-events \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --message="$PAYLOAD"
          
          echo ""
          echo "✅ Published to Pub/Sub successfully!"
          echo "The Cloud Workflow will now post to LinkedIn and Threads."

      - name: Summary
        if: always()
        run: |
          echo "## Social Media Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changed.outputs.skip }}" == "true" ]; then
            echo "⏭️ **Skipped**: No journal entries were changed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check.outputs.should_publish }}" != "true" ]; then
            echo "⏭️ **Skipped**: \`publish_social\` flag is not set to \`true\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable social publishing, add this to your entry's frontmatter:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
            echo "publish_social: true" >> $GITHUB_STEP_SUMMARY
            echo "linkedin: |" >> $GITHUB_STEP_SUMMARY
            echo "  Your LinkedIn content here..." >> $GITHUB_STEP_SUMMARY
            echo "threads: |" >> $GITHUB_STEP_SUMMARY
            echo "  Your Threads content here..." >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **Published**: Content sent to Pub/Sub for distribution" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Platforms**: LinkedIn, Threads" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check [Cloud Workflows](https://console.cloud.google.com/workflows) for execution status." >> $GITHUB_STEP_SUMMARY
          fi
